@model DataAccess.Models.InvoiceModel

@{
    var defaultGridPageSize = 20;
    var gridPageSizes = "10,20,50,100,500";
}

@Html.ValidationSummary(true)
@Html.HiddenFor(model => model.Id)
<div class="content">
    <div class="form-horizontal">
        <div class="panel-group">
            <strong style="font-size: 16px">Main information</strong>
            <div class="panel panel-default">
                <div class="panel-body">
                    @if (Model.OrderId.HasValue)
                    {
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label class="control-label">Order code</label>
                                    </div>
                                    <div class="col-md-8">
                                        <input disabled="disabled" type="text" id="@Html.IdFor(model => model.OrderCode)" value="@Model.OrderCode" class="k-textbox" style="width: 80%; background: silver; opacity: 0.7"/>
                                        <input type="hidden" name="@Html.IdFor(model => model.OrderCode)" value="@Model.OrderCode"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="col-md-4">
                                    <label class="control-label">Invoice code</label>
                                </div>
                                <div class="col-md-8">
                                    <input disabled="disabled" type="text" id="@Html.IdFor(model => model.Code)" value="@Model.Code" class="k-textbox" style="width: 80%; background: silver; opacity: 0.7"/>
                                    <input type="hidden" name="@Html.IdFor(model => model.Code)" value="@Model.Code"/>
                                    @Html.ValidationMessageFor(model => model.Code, "", new {@class = "text-danger"})
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="col-md-4">
                                    <label class="control-label">Customer</label>
                                </div>
                                <div class="col-md-8">
                                    @Html.EditorFor(model => model.CustomerName, new {htmlAttributes = new {@class = "k-textbox", style = "width: 80%"}})
                                    @Html.ValidationMessageFor(model => model.CustomerName, "", new {@class = "text-danger"})
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="col-md-4">
                                    <label class="control-label">Phone number</label>
                                </div>
                                <div class="col-md-8">
                                    @Html.EditorFor(model => model.CustomerPhone, new {htmlAttributes = new {@class = "k-textbox", style = "width: 80%"}})
                                    @Html.ValidationMessageFor(model => model.CustomerPhone, "", new {@class = "text-danger"})
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="col-md-2">
                                <label class="control-label">Address</label>
                            </div>
                            <div class="col-md-10">
                                @Html.TextAreaFor(model => model.CustomerAddress, new {@class = "k-textbox", style = "width: 95%"})
                                @Html.ValidationMessageFor(model => model.CustomerAddress, "", new {@class = "text-danger"})
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="col-md-4">
                                <label class="control-label">Status</label>
                            </div>
                            <div class="col-md-8">
                                <input id="@Html.IdFor(model => model.Status)" style="width: 85%"/>
                                <input type="hidden" name="@Html.IdFor(model => model.Status)" value="@Html.AttributeEncode(Model.Status)"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-group">
            <strong style="font-size: 16px">More information</strong>
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="col-md-4">
                                    <label class="control-label">Created by</label>
                                </div>
                                <div class="col-md-8">
                                    <input id="@Html.IdFor(model => model.CreatedBy)" />
                                    <input type="hidden" name="@Html.IdFor(model => model.CreatedBy)" value="@Model.CreatedBy" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="col-md-4">
                                    <label class="control-label">Approved by</label>
                                </div>
                                <div class="col-md-8">
                                    <input id="@Html.IdFor(model => model.ApprovedBy)" name="@Html.IdFor(model => model.ApprovedBy)" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="col-md-4">
                                    <label class="control-label">Created date</label>
                                </div>
                                <div class="col-md-8">
                                    <input type="datetime" id="@Html.IdFor(model => model.CreatedDateTime)" value="@Model.CreatedDateTime" />
                                    <input type="hidden" name="@Html.IdFor(model => model.CreatedDateTime)" value="@Model.CreatedDateTime" />
                                    @Html.ValidationMessageFor(model => model.CreatedDateTime, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="col-md-4">
                                    <label class="control-label">Approved date</label>
                                </div>
                                <div class="col-md-8">
                                    <input type="datetime" id="@Html.IdFor(model => model.ApprovedDateTime)" value="@Model.ApprovedDateTime" />
                                    <input type="hidden" name="@Html.IdFor(model => model.ApprovedDateTime)" value="@Model.ApprovedDateTime" />
                                    @Html.ValidationMessageFor(model => model.ApprovedDateTime, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="col-md-2">
                                <label class="control-label">Note</label>
                            </div>
                            <div class="col-md-10">
                                @Html.TextAreaFor(model => model.Description, new { @class = "k-textbox", style = "width: 95%" })
                                @Html.ValidationMessageFor(model => model.Description, "", new { @class = "text-danger" })
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        @if (Model.Id > 0)
        {
            <div class="panel-group">
                <strong style="font-size: 16px">Product list</strong>
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label class="control-label">Product code</label>
                                    </div>
                                    <div class="col-md-8">
                                        @Html.EditorFor(model => model.ProductCode, new { htmlAttributes = new { @class = "k-textbox", style = "width: 80%" } })
                                        @Html.ValidationMessageFor(model => model.ProductCode, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label class="control-label">Quantity</label>
                                    </div>
                                    <div class="col-md-8">
                                        @Html.EditorFor(model => model.Quantity, new { htmlAttributes = new { min = 0 } })
                                        <script>
                                        $(document).ready(function() {
                                            $("#@Html.IdFor(model => model.Quantity)").kendoNumericTextBox({
                                                format: "#"
                                            });
                                        });
                                        </script>
                                        @Html.ValidationMessageFor(model => model.Quantity, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                            @if (!Model.ApprovedBy.HasValue && !Model.OrderId.HasValue)
                            {
                                <div class="col-md-4">
                                    <div id="window"></div>
                                    <div class="pull-right">
                                        <a href="#" id="button-add-product" class="btn bg-blue">
                                            <i class="fa fa-plus-square"></i>
                                            Add
                                        </a>
                                        <a href="#" id="button-search-product" class="btn bg-blue">
                                            <i class="fa fa-plus-square"></i>
                                            Select from product list
                                        </a>
                                    </div>
                                </div>
                                <input type="submit" id="btnRefreshItems" style="display: none" />
                                <script>
                                $(document).ready(function () {
                                    $('#btnRefreshItems').click(function() {
                                        //refresh grid
                                        var grid = $("#main-grid").data('kendoGrid');
                                        grid.dataSource.read();
                                        //return false to don't reload a page
                                        return false;
                                    });
                                    $("#button-search-product").click(function () {
                                        var productWindow = $("#window");
                                        productWindow.kendoWindow({
                                            title: "Select product",
                                            actions: ["Close"],
                                            content: "/Admin/Invoice/ProductAddPopup?invoiceId=" +
                                                "@Model.Id" +
                                                "&btnId=btnRefreshItems&formId=invoice-edit-form",
                                            visible: false
                                        }).data('kendoWindow').center();
                                        productWindow.data("kendoWindow").open().maximize();
                                    });
                                });
                                </script>
                            }
                        </div>

                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div id="main-grid"></div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <strong style="font-size: 16px">Please save information first!</strong>
        }
    </div>
</div>
<script>
    $(document).ready(function () {
        var data = [
            { text: "Open", value: "False" },
            { text: "Approved", value: "True" }
        ];
        $("#@Html.IdFor(model => model.Status)").kendoDropDownList({
            dataTextField: "text",
            dataValueField: "value",
            dataSource: data,
            value: "@Model.Status",
            enable: false
        });

        $("#@Html.IdFor(model => model.CreatedBy)").kendoDropDownList({
            dataTextField: "UserName",
            dataValueField: "Id",
            enable: false,
            dataSource: {
                type: "json",
                serverFiltering: true,
                transport: {
                    read: {
                        dataType: "json",
                        url: "/User/GetAllAdminUser"
                    }
                }
            },
            value: "@Model.CreatedBy"
        });

        $("#@Html.IdFor(model => model.ApprovedBy)").kendoDropDownList({
            dataTextField: "UserName",
            dataValueField: "Id",
            optionLabel: " ",
            enable: false,
            dataSource: {
                type: "json",
                serverFiltering: true,
                transport: {
                    read: {
                        dataType: "json",
                        url: "/User/GetAllAdminUser"
                    }
                }
            },
            value: "@Model.ApprovedBy"
        });

        $("#@Html.IdFor(model => model.CreatedDateTime)").kendoDatePicker({
            culture: "vi-VN",
            format: "dd-MM-yyyy HH:mm:ss"
        }).data("kendoDatePicker").enable(false);

        $("#@Html.IdFor(model => model.ApprovedDateTime)").kendoDatePicker({
            culture: "vi-VN",
            format: "dd-MM-yyyy HH:mm:ss"
        }).data("kendoDatePicker").enable(false);

        function additionalData() {
            var data = {
                InvoiceId: "@Model.Id"
            };
            addAntiForgeryToken(data);
            return data;
        }


        $(document).ready(function () {
                        var current;
                        $("#main-grid").kendoGrid({
                            dataSource: {
                                type: "json",
                                autoSync: false,
                                transport: {
                                    read: {
                                        url: "@Html.Raw(Url.Action("InvoiceDetailList", "Invoice"))", //edit
                                        type: "POST",
                                        dataType: "json",
                                        data: additionalData
                                    },
                                    update: {
                                        url: "@Html.Raw(Url.Action("InvoiceDetailEdit", "Invoice"))",
                                        type: "POST",
                                        dataType: "json",
                                        data: addAntiForgeryToken
                                    },
                                    destroy: {
                                        url: "@Html.Raw(Url.Action("InvoiceDetailDelete", "Invoice"))",
                                        type: "POST",
                                        dataType: "json"
                                    },
                                    //parameterMap: function(data, operation) {
                                    //    if (operation !== "read") {
                                    //        return data;
                                    //    } else {
                                    //        //for some reasons only such "Filter" data be parsed
                                    //        return JSON.stringify(data);
                                    //    }
                                    //}
                                },
                                schema: {
                                    data: "Data",
                                    total: "Total",
                                    errors: "Errors",
                                    model: {
                                        id: "Id",
                                        fields: {
                                            ProductImagePath: { editable: false, type: "string" },
                                            ProductCode: { editable: false, type: "string" },
                                            ProductName: { editable: false, type: "string" },
                                            UnitPrice: { editable: true, type: "number" },
                                            Quantity: { editable: true, type: "number" },
                                            Amount: { editable: false, type: "number" }
                                        }
                                    }
                                },
                                requestEnd: function(e) {
                                    if (e.type === "create" || e.type === "update") {
                                        this.read();
                                    }
                                },
                                error: function(e) {
                                    display_kendoui_grid_error(e);
                                    // Cancel the changes
                                    this.cancelChanges();
                                },
                                pageSize: @(defaultGridPageSize),
                                serverPaging: true,
                                serverFiltering: false,
                                serverSorting: false
                            },
                            pageable: {
                                refresh: true,
                                pageSizes: [@(gridPageSizes)],
                                messages: {
                                    itemsPerPage: "Number of product on the page",
                                    empty: "No product",
                                    display: "{0} - {1} of {2} product",
                                },
                            },
                            scrollable: false,
                            columns: [
                                {
                                    template: '<img src="../../../..#=ProductImagePath#" width="100px" alt="image" />',
                                    width: 120,
                                    title: "Image",
                                    field: "ProductImagePath"
                                }, {
                                    field: "ProductCode",
                                    title: "Code"
                                }, {
                                    field: "ProductName",
                                    title: "Name"
                                }, {
                                    field: "UnitPrice",
                                    title: "Unit price",
                                    format: "{0:$#,#}"
                                }, {
                                    field: "Quantity",
                                    title: "Quantity",
                                    format: "{0:#,#}"
                                }, {
                                    field: "Amount",
                                    title: "Amount",
                                    format: "{0:$#,#}"
                                }, {
                                    command: ["edit", "destroy"],
                                    hidden: @((Model.ApprovedBy.HasValue || Model.OrderId.HasValue).ToString().ToLower())
                                }
                            ],
                            editable:"popup"
                        });

        });


        $("#button-add-product").click(function(e) {
            e.preventDefault();
            var qty = $("#@Html.IdFor(model => model.Quantity)").val();
            if (qty === 0) {
                alert('Please enter quantity!');
                return;
            }
            $.post("@Url.Action("AddInvoiceDetail", "Invoice")",
                    addAntiForgeryToken({
                        InvoiceId: @Model.Id,
                        ProductCode: $("#@Html.IdFor(model => model.ProductCode)").val(),
                        Quantity: $("#@Html.IdFor(model => model.Quantity)").val()
                    }))
                .done(function(data) {
                    if (data.IsProductSkusNotFound) {
                        alert('Not found product.');
                        return;
                    }
                    if (data.IsDupp) {
                        alert('Product is existed in invoice.');
                        return;
                    }
                    var grid = $('#main-grid').data('kendoGrid');
                    grid.dataSource.page(1);
                })
                .then(function() {

                });
        });
    });

</script>
